const API_URL = "http://localhost/aplicativo/backend/Cruds/aplicativo.php";

// üß© Tipos
export type Aplicativo = {
  id: string;
  nombreCorto: string;
  nombreCompleto: string;
  registro: string;
  fechaAdquisicion: string;
  fechaImplementacion: string;
  fechaActualizacion: string;
  anioCreacion: number;
  numeroUsuarios: number;
  administradorUsuario: string;
  valorEstimado: number;
  transaccionesMensuales: number;
  proveedor: string;
  version: string;
  soporteVigente: boolean;
  tiempoReinicio: string;
  horaReinicio: string;
  sla: string;
  https: boolean;
  enlace: string;
  rutaDocTecnico: string;
  areaRequirente: string;
  subarea: string;
  proceso: string;
  descripcion: string;
  observaciones: string;
  activo: boolean;

  criticidadId: number;
  tipoCriticidadId: number;
  herramientaId: number;
  tipoAccesoId: number;
  tipoAplicativoId: number;
  fuenteDatosId: number;
  estadoId: number;
  interfazId: number;
  fuenteId: number;
  descripcionTecnicaId: number;
  contextoFuncionalId: number;
};

export type AplicativoForm = Omit<Aplicativo, "id">;

type BackendResponse = {
  status: string;
  mensaje?: string;
  aplcodigo?: number;
};

// üìÖ Fecha actual
export const getToday = (): string => new Date().toISOString().split("T")[0];

// üîÅ Mapeo individual
export function mapToAplicativo(raw: any): Aplicativo {
  return {
    id: `${raw.aplcodigo}`,
    nombreCorto: raw.aplnombrecorto ?? "",
    nombreCompleto: raw.aplnombrecompleto ?? "",
    registro: raw.aplregistro ?? "",
    fechaAdquisicion: raw.aplfechaadquisicion?.split("T")[0] ?? "",
    fechaImplementacion: raw.aplfechaimplementacion?.split("T")[0] ?? "",
    fechaActualizacion: raw.aplfechaactualizacion?.split("T")[0] ?? "",
    anioCreacion: raw.aplanocreacion ?? 0,
    numeroUsuarios: raw.aplnumerousuario ?? 0,
    administradorUsuario: raw.apladministradorusuario ?? "",
    valorEstimado: raw.aplvalorestimado ?? 0,
    transaccionesMensuales: raw.apltransaccionesmensuales ?? 0,
    proveedor: raw.aplproveedor ?? "",
    version: raw.aplversion ?? "",
    soporteVigente: raw.aplhsoportevigente === 1,
    tiempoReinicio: raw.apltiemporeinicio ?? "",
    horaReinicio: raw.aplhorareinicio ?? "",
    sla: raw.aplsla ?? "",
    https: raw.aplhttps === 1,
    enlace: raw.aplenlace ?? "",
    rutaDocTecnico: raw.aplrutadoctecnico ?? "",
    areaRequirente: raw.aplarearequirente ?? "",
    subarea: raw.aplsubarea ?? "",
    proceso: raw.aplproceso ?? "",
    descripcion: raw.apldescripcion ?? "",
    observaciones: raw.aplobservaciones ?? "",
    activo: raw.estadoActivo === 1,

    criticidadId: raw.cricodigo ?? 0,
    tipoCriticidadId: raw.tipccodigo ?? 0,
    herramientaId: raw.hercodigo ?? 0,
    tipoAccesoId: raw.tipaccesocodigo ?? 0,
    tipoAplicativoId: raw.tipcodigo ?? 0,
    fuenteDatosId: raw.tfdcodigo ?? 0,
    estadoId: raw.estcodigo ?? 0,
    interfazId: raw.intcodigo ?? 0,
    fuenteId: raw.fuecodigo ?? 0,
    descripcionTecnicaId: raw.descodigo ?? 0,
    contextoFuncionalId: raw.concodigo ?? 0,
  };
}

// üîÅ Agrupaci√≥n
export function groupAplicativos(rows: any[]): Aplicativo[] {
  const map = new Map<string, Aplicativo>();
  for (const row of rows) {
    const id = `${row.aplcodigo}`; // ‚úÖ sin prefijo artificial
    if (!map.has(id)) {
      map.set(id, mapToAplicativo(row));
    }
  }
  return Array.from(map.values());
}

// üì• Obtener todos
export const obtenerAplicativos = async (): Promise<Aplicativo[]> => {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ accion: "read" }),
    });

    const text = await res.text();
    if (text.trim().startsWith("<")) throw new Error("Respuesta HTML inesperada");

    const data = JSON.parse(text);
    if (!Array.isArray(data)) throw new Error("Formato inesperado");

    return data.map(mapToAplicativo);
  } catch (error) {
    console.error("Error al obtener aplicativos:", error);
    return [];
  }
};

// üì• Obtener uno por ID
export const obtenerAplicativoPorId = async (id: string): Promise<Aplicativo | null> => {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ accion: "obtener", aplcodigo: id }),
    });

    const text = await res.text();
    const data = JSON.parse(text);
    if (!data || !data.aplcodigo) return null;

    return mapToAplicativo(data);
  } catch (error) {
    console.error("Error al obtener aplicativo por ID:", error);
    return null;
  }
};

// üì§ Crear
export const crearAplicativo = async (a: AplicativoForm): Promise<number | null> => {
  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ accion: "insert", ...a }),
    });

    const text = await res.text();
    const result: BackendResponse = JSON.parse(text);
    return result.status === "insertado" ? result.aplcodigo ?? null : null;
  } catch (error) {
    console.error("Error al crear aplicativo:", error);
    return null;
  }
};

// ‚úèÔ∏è Editar
export const editarAplicativo = async (a: Aplicativo): Promise<boolean> => {
  try {
    const aplcodigo = parseInt(a.id); // ‚úÖ sin replace
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ accion: "update", aplcodigo, ...a }),
    });

    const text = await res.text();
    const result: BackendResponse = JSON.parse(text);
    return result.status === "actualizado";
  } catch (error) {
    console.error("Error al editar aplicativo:", error);
    return false;
  }
};

// üóëÔ∏è Eliminar
export const eliminarAplicativo = async (id: string): Promise<boolean> => {
  try {
    const aplcodigo = parseInt(id); // ‚úÖ sin replace
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ accion: "delete", aplcodigo }),
    });

    const text = await res.text();
    const result: BackendResponse = JSON.parse(text);
    return result.status === "deshabilitado";
  } catch (error) {
    console.error("Error al eliminar aplicativo:", error);
    return false;
  }
};
