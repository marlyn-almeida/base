USE [MSQCATPRO_MA]
GO
/****** Object:  StoredProcedure [dbo].[add_activo]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- Insertar nuevo activo físico
CREATE PROCEDURE [dbo].[add_activo]
    @Naturaleza NVARCHAR(50),
    @Activo NVARCHAR(50),
    @Gestion_TIC NVARCHAR(50),
    @Descripcion_Activo NVARCHAR(MAX),
    @Etiqueta_Activo_Fijo NVARCHAR(150),
    @Codigo_activo_Fijo_EBS NVARCHAR(50),
    @Centro_Costo NVARCHAR(50),
    @Fabricante NVARCHAR(100),
    @Modelo NVARCHAR(150),
    @Serie NVARCHAR(100),
    @Num_Contrato NVARCHAR(150),
    @Fecha_Recepcion DATETIME,
    @Caducidad_Garantia DATETIME,
    @ID_Zona INT,
    @Precio_Compra DECIMAL(18,2),
    @Ubicacion_Desc NVARCHAR(MAX),
    @Estado NVARCHAR(50)
AS
BEGIN
    INSERT INTO dbo.Activo_Fisico (
        Naturaleza, Activo, Gestion_TIC, Descripcion_Activo, Etiqueta_Activo_Fijo,
        Codigo_activo_Fijo_EBS, Centro_Costo, Fabricante, Modelo, Serie, Num_Contrato,
        Fecha_Recepcion, Caducidad_Garantia, ID_Zona, Precio_Compra, Ubicacion_Desc, Estado
    )
    VALUES (
        @Naturaleza, @Activo, @Gestion_TIC, @Descripcion_Activo, @Etiqueta_Activo_Fijo,
        @Codigo_activo_Fijo_EBS, @Centro_Costo, @Fabricante, @Modelo, @Serie, @Num_Contrato,
        @Fecha_Recepcion, @Caducidad_Garantia, @ID_Zona, @Precio_Compra, @Ubicacion_Desc, @Estado
    );
END;
GO
/****** Object:  StoredProcedure [dbo].[add_asignacion]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[add_asignacion]
    @EmpCodigo INT,
    @ID_Activo_Fisico INT
AS
BEGIN
    -- Validar existencia del activo
    IF NOT EXISTS (
        SELECT 1 FROM Activo_Fisico
        WHERE id_activo_fisico = @ID_Activo_Fisico
    )
    BEGIN
        RAISERROR('El activo físico no existe.', 16, 1);
        RETURN;
    END;

    -- Validar existencia del empleado
    IF NOT EXISTS (
        SELECT 1 FROM empleado
        WHERE empcodigo = @EmpCodigo
    )
    BEGIN
        RAISERROR('El empleado no existe.', 16, 1);
        RETURN;
    END;

    -- Insertar nueva asignación sin validar si ya está asignado
    INSERT INTO Empleado_Activo (EmpCodigo, ID_Activo_Fisico, Fecha_Asignacion)
    VALUES (@EmpCodigo, @ID_Activo_Fisico, GETDATE());
END;
GO
/****** Object:  StoredProcedure [dbo].[count_aplicativos_activos]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[count_aplicativos_activos]
AS
BEGIN
    SELECT COUNT(*) AS total_activos
    FROM aplicativo
    WHERE aplactivo = 1;
END
GO
/****** Object:  StoredProcedure [dbo].[create_activo]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[create_activo]
    @Naturaleza NVARCHAR(50),
    @Activo NVARCHAR(50),
    @Gestion_TIC NVARCHAR(50),
    @Descripcion_Activo NVARCHAR(MAX),
    @Etiqueta_Activo_Fijo NVARCHAR(150),
    @Codigo_activo_Fijo_EBS NVARCHAR(50),
    @Centro_Costo NVARCHAR(50),
    @Fabricante NVARCHAR(100),
    @Modelo NVARCHAR(150),
    @Serie NVARCHAR(100),
    @Num_Contrato NVARCHAR(150),
    @Fecha_Recepcion DATETIME,
    @Caducidad_Garantia DATETIME,
    @ID_Zona INT,
    @Precio_Compra DECIMAL(18,2),
    @Ubicacion_Desc NVARCHAR(MAX),
    @Estado NVARCHAR(50)
AS
BEGIN
    -- Validación: ¿existe la zona?
    IF NOT EXISTS (
        SELECT 1 FROM dbo.ZONA_A WHERE ID_Zona = @ID_Zona
    )
    BEGIN
        RAISERROR('La zona especificada no existe.', 16, 1);
        RETURN;
    END;

    -- Inserción
    INSERT INTO dbo.Activo_Fisico (
        Naturaleza,
        Activo,
        Gestion_TIC,
        Descripcion_Activo,
        Etiqueta_Activo_Fijo,
        Codigo_activo_Fijo_EBS,
        Centro_Costo,
        Fabricante,
        Modelo,
        Serie,
        Num_Contrato,
        Fecha_Recepcion,
        Caducidad_Garantia,
        ID_Zona,
        Precio_Compra,
        Ubicacion_Desc,
        Estado
    )
    VALUES (
        @Naturaleza,
        @Activo,
        @Gestion_TIC,
        @Descripcion_Activo,
        @Etiqueta_Activo_Fijo,
        @Codigo_activo_Fijo_EBS,
        @Centro_Costo,
        @Fabricante,
        @Modelo,
        @Serie,
        @Num_Contrato,
        @Fecha_Recepcion,
        @Caducidad_Garantia,
        @ID_Zona,
        @Precio_Compra,
        @Ubicacion_Desc,
        @Estado
    );

    SELECT SCOPE_IDENTITY() AS id_activo_fisico;
END;
GO
/****** Object:  StoredProcedure [dbo].[delete_aplicativo]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[delete_aplicativo]
    @aplcodigo INT
AS
BEGIN
    SET NOCOUNT ON;

    IF NOT EXISTS (SELECT 1 FROM aplicativo WHERE aplcodigo = @aplcodigo)
        THROW 50200, 'El aplicativo especificado no existe.', 1;

    UPDATE aplicativo
    SET aplactivo = 0,
        aplfechaactualizacion = GETDATE()
    WHERE aplcodigo = @aplcodigo;
END
GO
/****** Object:  StoredProcedure [dbo].[delete_asignacion]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[delete_asignacion]
    @ID_Empleado_Activo INT
AS
BEGIN
    DELETE FROM Empleado_Activo
    WHERE ID_Empleado_Activo = @ID_Empleado_Activo;
END;
GO
/****** Object:  StoredProcedure [dbo].[delete_employee]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[delete_employee]
    @empcodigo INT
AS
BEGIN
    UPDATE empleado
    SET empactivo = 0
    WHERE empcodigo = @empcodigo;
END
GO
/****** Object:  StoredProcedure [dbo].[DeleteIP]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[DeleteIP]
    @ID_IP INT
AS
BEGIN
    DELETE FROM IP WHERE ID_IP = @ID_IP
END
GO
/****** Object:  StoredProcedure [dbo].[disable_activo]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE    PROCEDURE [dbo].[disable_activo]
    @id_activo_fisico INT
AS
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM dbo.Activo_Fisico WHERE id_activo_fisico = @id_activo_fisico
    )
    BEGIN
        RAISERROR('Activo no encontrado.', 16, 1);
        RETURN;
    END;

    UPDATE dbo.Activo_Fisico
    SET Estado = 'Deshabilitado'
    WHERE id_activo_fisico = @id_activo_fisico;

    SELECT 'Activo deshabilitado correctamente.' AS Mensaje;
END;
GO
/****** Object:  StoredProcedure [dbo].[disable_servidor]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[disable_servidor]
    @ID_Servidor INT,
    @estcodigo_inactivo INT
AS
BEGIN
    SET NOCOUNT ON;

    -- 🔍 Validación de existencia del servidor
    IF NOT EXISTS (SELECT 1 FROM Servidores WHERE ID_Servidor = @ID_Servidor)
        THROW 54020, 'Servidor no encontrado.', 1;

    -- 🔍 Validación del código de estado inactivo
    IF NOT EXISTS (
        SELECT 1 FROM estado 
        WHERE estcodigo = @estcodigo_inactivo AND estactivo = 0
    )
        THROW 54021, 'Código de estado inactivo inválido.', 1;

    -- 🛑 Desactivación lógica del servidor
    UPDATE dbo.Servidores
    SET estcodigo = @estcodigo_inactivo
    WHERE ID_Servidor = @ID_Servidor;
END
GO
/****** Object:  StoredProcedure [dbo].[disableActivo]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[disableActivo]
    @id_activo_fisico INT
AS
BEGIN
    UPDATE dbo.Activo_Fisico
    SET Estado = 'Deshabilitado'
    WHERE id_activo_fisico = @id_activo_fisico;
END;
GO
/****** Object:  StoredProcedure [dbo].[edit_activo]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE    PROCEDURE [dbo].[edit_activo]
    @id_activo_fisico INT,
    @Naturaleza NVARCHAR(50),
    @Activo NVARCHAR(50),
    @Gestion_TIC NVARCHAR(50),
    @Descripcion_Activo NVARCHAR(MAX),
    @Etiqueta_Activo_Fijo NVARCHAR(150),
    @Codigo_activo_Fijo_EBS NVARCHAR(50),
    @Centro_Costo NVARCHAR(50),
    @Fabricante NVARCHAR(100),
    @Modelo NVARCHAR(150),
    @Serie NVARCHAR(100),
    @Num_Contrato NVARCHAR(150),
    @Fecha_Recepcion DATETIME,
    @Caducidad_Garantia DATETIME,
    @ID_Zona INT,
    @Precio_Compra DECIMAL(18,2),
    @Ubicacion_Desc NVARCHAR(MAX),
    @Estado NVARCHAR(50)
AS
BEGIN
    IF NOT EXISTS (
        SELECT 1 FROM dbo.Activo_Fisico WHERE id_activo_fisico = @id_activo_fisico
    )
    BEGIN
        RAISERROR('Activo no encontrado.', 16, 1);
        RETURN;
    END;

    UPDATE dbo.Activo_Fisico
    SET Naturaleza = @Naturaleza,
        Activo = @Activo,
        Gestion_TIC = @Gestion_TIC,
        Descripcion_Activo = @Descripcion_Activo,
        Etiqueta_Activo_Fijo = @Etiqueta_Activo_Fijo,
        Codigo_activo_Fijo_EBS = @Codigo_activo_Fijo_EBS,
        Centro_Costo = @Centro_Costo,
        Fabricante = @Fabricante,
        Modelo = @Modelo,
        Serie = @Serie,
        Num_Contrato = @Num_Contrato,
        Fecha_Recepcion = @Fecha_Recepcion,
        Caducidad_Garantia = @Caducidad_Garantia,
        ID_Zona = @ID_Zona,
        Precio_Compra = @Precio_Compra,
        Ubicacion_Desc = @Ubicacion_Desc,
        Estado = @Estado
    WHERE id_activo_fisico = @id_activo_fisico;
END;
GO
/****** Object:  StoredProcedure [dbo].[get_activo_by_id]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE    PROCEDURE [dbo].[get_activo_by_id]
    @id_activo_fisico INT
AS
BEGIN
    SELECT 
        af.id_activo_fisico,
        af.Naturaleza,
        af.Activo,
        af.Gestion_TIC,
        af.Descripcion_Activo,
        af.Etiqueta_Activo_Fijo,
        af.Codigo_activo_Fijo_EBS,
        af.Centro_Costo,
        af.Fabricante,
        af.Modelo,
        af.Serie,
        af.Num_Contrato,
        af.Fecha_Recepcion,
        af.Caducidad_Garantia,
        af.ID_Zona,
        z.Zona AS Nombre_Zona,
        af.Precio_Compra,
        af.Ubicacion_Desc,
        af.Estado
    FROM dbo.Activo_Fisico af
    LEFT JOIN dbo.ZONA_A z ON af.ID_Zona = z.ID_Zona
    WHERE af.id_activo_fisico = @id_activo_fisico;
END;
GO
/****** Object:  StoredProcedure [dbo].[get_activos]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE    PROCEDURE [dbo].[get_activos]
AS
BEGIN
    SELECT 
        af.id_activo_fisico,
        af.Naturaleza,
        af.Activo,
        af.Descripcion_Activo,
        af.Etiqueta_Activo_Fijo,
        af.Codigo_activo_Fijo_EBS,
        af.Fabricante,
        af.Modelo,
        af.Serie,
        af.Num_Contrato,
        af.Fecha_Recepcion,
        af.Caducidad_Garantia,
        af.ID_Zona,
        z.Zona AS Nombre_Zona,
        af.Precio_Compra,
        af.Ubicacion_Desc,
        af.Estado
    FROM dbo.Activo_Fisico af
    LEFT JOIN dbo.ZONA_A z ON af.ID_Zona = z.ID_Zona
    ORDER BY af.id_activo_fisico DESC;
END;
GO
/****** Object:  StoredProcedure [dbo].[get_aplicativo_por_id]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
-- Creado por Marlyn Almeida – 20/08/2025
CREATE PROCEDURE [dbo].[get_aplicativo_por_id]
    @aplcodigo INT
AS
BEGIN
    SELECT * FROM dbo.aplicativo WHERE aplcodigo = @aplcodigo
END
GO
/****** Object:  StoredProcedure [dbo].[get_aplicativos]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[get_aplicativos]
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        -- 🆔 Identificación
        a.aplcodigo               AS aplcodigo,
        a.aplnombrecorto          AS nombreCorto,
        a.aplnombrecompleto       AS nombreCompleto,
        a.aplregistro             AS registro,
        a.aplactivo               AS estadoActivo,

        -- 📅 Fechas
        a.aplfechaadquisicion     AS fechaAdquisicion,
        a.aplfechaimplementacion  AS fechaImplementacion,
        a.aplfechaactualizacion   AS fechaActualizacion,
        a.aplanocreacion          AS anioCreacion,

        -- 👥 Usuarios
        a.aplnumerousuario        AS numeroUsuarios,
        a.apladministradorusuario AS administradorUsuario,
        a.aplvalorestimado        AS valorEstimado,
        a.apltransaccionesmensuales AS transaccionesMensuales,

        -- 🏢 Proveedor y versión
        a.aplproveedor            AS proveedor,
        a.aplversion              AS version,

        -- 🔧 Soporte y reinicio
        a.aplhsoportevigente      AS soporteVigente,
        a.apltiemporeinicio       AS tiempoReinicio,
        a.aplhorareinicio         AS horaReinicio,
        a.aplsla                  AS sla,

        -- 🌐 Acceso y seguridad
        a.aplhttps                AS https,
        a.aplenlace               AS enlace,
        a.aplrutadoctecnico       AS rutaDocTecnico,

        -- 🏢 Área funcional
        a.aplarearequirente       AS areaRequirente,
        a.aplsubarea              AS subarea,
        a.aplproceso              AS proceso,

        -- 📌 Descripción y observaciones
        a.apldescripcion          AS descripcion,
        a.aplobservaciones        AS observaciones,

        -- 🧩 Relaciones semánticas (códigos + nombres)
        a.cricodigo               AS idCriticidad,
        c.crinombre               AS criticidad,

        a.tipccodigo              AS idTipoCatastro,
        tc.tipcnombre             AS tipoCatastro,

        a.hercodigo               AS idHerramienta,
        h.hernombre               AS herramienta,

        a.tipaccesocodigo         AS idTipoAcceso,
        ta.tipaccesonombre        AS tipoAcceso,

        a.tipcodigo               AS idTipoUsuario,
        tu.tipnombre              AS tipoUsuario,

        a.tfdcodigo               AS idTipoFuenteDatos,
        tf.tfdnombre              AS tipoFuenteDatos,

        a.estcodigo               AS idEstado,
        e.estnombre               AS estado,

        a.intcodigo               AS idTipoIntegracion,
        ti.intnombre              AS tipoIntegracion,

        a.fuecodigo               AS idFuente,
        f.fuenombre               AS fuente,

        a.descodigo               AS idDesarrollo,
        d.desnombre               AS desarrollo,

        a.concodigo               AS idControl,
        co.connombre              AS control

    FROM dbo.aplicativo a
    INNER JOIN dbo.criticidad c         ON a.cricodigo = c.cricodigo
    INNER JOIN dbo.tipo_catastro tc     ON a.tipccodigo = tc.tipccodigo
    INNER JOIN dbo.herramienta h        ON a.hercodigo = h.hercodigo
    INNER JOIN dbo.tipo_acceso ta       ON a.tipaccesocodigo = ta.tipaccesocodigo
    INNER JOIN dbo.tipo_usuario tu      ON a.tipcodigo = tu.tipcodigo
    INNER JOIN dbo.tipo_fuentedatos tf  ON a.tfdcodigo = tf.tfdcodigo
    INNER JOIN dbo.estado e             ON a.estcodigo = e.estcodigo
    INNER JOIN dbo.tipo_integracion ti  ON a.intcodigo = ti.intcodigo
    INNER JOIN dbo.fuente f             ON a.fuecodigo = f.fuecodigo
    INNER JOIN dbo.desarrollo d         ON a.descodigo = d.descodigo
    INNER JOIN dbo.control co           ON a.concodigo = co.concodigo

    ORDER BY a.aplcodigo DESC;
END;
GO
/****** Object:  StoredProcedure [dbo].[get_asignados]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[get_asignados]
AS
BEGIN
    SELECT ID_Empleado_Activo, EmpCodigo, ID_Activo_Fisico, Fecha_Asignacion
    FROM Empleado_Activo
    WHERE Fecha_Desasignacion IS NULL;
END;
GO
/****** Object:  StoredProcedure [dbo].[get_employees]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[get_employees]
AS
BEGIN
    SELECT 
        e.empcodigo           AS empcodigo,
        e.empnombres          AS empnombres,
        e.empapellidopaterno  AS empapellidopaterno,
        e.empapellidomaterno  AS empapellidomaterno,
        e.empcedula           AS empcedula,
        e.empemail            AS empemail,
        e.empcelular          AS empcelular,
        e.emptiposangre       AS empsangre,
        e.empsexo             AS empsexo,
        e.empfechainicio      AS fechainicio,
        e.empfechacreacion    AS empfechacreacion,
        e.empusuario          AS empusuario,
        e.empactivo           AS empactivo,
        e.empdescripcion      AS empdescripcion,
        e.empobservaciones    AS empobservacion,
        a.arenombre           AS arenombre,
        r.rolnombre           AS rolnombre,
        p.pernombre           AS pernombre
    FROM empleado e
    LEFT JOIN areaempleado ae     ON e.empcodigo = ae.empcodigo
    LEFT JOIN area a              ON ae.arecodigo = a.arecodigo
    LEFT JOIN rolempleado re      ON e.empcodigo = re.empcodigo
    LEFT JOIN rol r               ON re.rolcodigo = r.rolcodigo
    LEFT JOIN perfilempleado pe   ON e.empcodigo = pe.empcodigo
    LEFT JOIN perfil p            ON pe.percodigo = p.percodigo
END

GO
/****** Object:  StoredProcedure [dbo].[get_historial]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[get_historial]
AS
BEGIN
    SELECT ID_Empleado_Activo, EmpCodigo, ID_Activo_Fisico, Fecha_Asignacion, Fecha_Desasignacion
    FROM Empleado_Activo
    ORDER BY Fecha_Asignacion DESC;
END;
GO
/****** Object:  StoredProcedure [dbo].[get_servidor_by_id]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[get_servidor_by_id]
    @ID_Servidor INT
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        -- 🆔 Identificación
        S.ID_Servidor,
        S.Nombre_Servidor,
        S.Monitoreo_PRTG,
        S.Disponibilidad,
        S.Observacion,
        S.Registro_PRTG,

        -- 🖥️ Hardware y sistema
        S.Tipo_Equipo,
        S.OS,
        S.Espacio_Disco_GB,
        S.numero_discos,
        S.uso_disco,
        S.memoria_ram,
        S.procesador,
        S.tipo_disco,
        S.nucleos,
        S.hipervisor,
        S.velocidad,
        S.interfaz_red,

        -- 🧠 Criticidad y servicio
        S.Criticidad_Organizacion_1,
        S.Criticidad_Organizacion_2,
        S.Tipo_servicio,
        S.Ambiente_Ejecucion,

        -- 📅 Ejecución y respaldo
        S.Dia_Ejecucion_Serv,
        S.Hora_Serv,
        S.tiempo_Respaldo_Serv,
        S.ruta_respaldo_Granular_Serv,
        S.Periodo_Retencion_Serv,
        S.Doble_Copia_Serv,
        S.Dia_Ejecucion_Almac,
        S.Hora_Almac,
        S.ruta_respaldo_Granular_Almac,
        S.Periodo_Retencion_Almac,
        S.Doble_Copia_Almac,

        -- 🔐 Seguridad
        S.antivirus,
        S.firewall,
        S.reglas_aplicadas,

        -- 📦 Despliegue
        S.fech_despliegue,

        -- 🔗 Relaciones semánticas
        E.estcodigo,
        E.estnombre AS Estado,
        Z.ID_Zona,
        Z.Zona,
        Z.Provincia,
        Z.Ciudad,
        Z.Canton,
        Z.Locacion,
        Z.Ubicacion,
        Z.VCenter,
        B.ID_Base,
        B.Nombre_Base,
        B.Nombre_Instancia,
        B.Tipo_Base,
        B.Descripcion

    FROM dbo.Servidores S
    LEFT JOIN dbo.estado E ON S.estcodigo = E.estcodigo
    LEFT JOIN dbo.ZONA_A Z ON S.ID_Zona = Z.ID_Zona
    LEFT JOIN dbo.BaseDatos B ON S.ID_Base = B.ID_Base
    WHERE S.ID_Servidor = @ID_Servidor;
END
GO
/****** Object:  StoredProcedure [dbo].[get_servidores]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[get_servidores]
    @estcodigo INT = NULL,
    @ID_Zona INT = NULL,
    @ID_Base INT = NULL
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        S.ID_Servidor,
        S.Nombre_Servidor,
        S.Tipo_Equipo,
        S.OS,
        S.memoria_ram,
        S.procesador,
        S.numero_discos,
        S.uso_disco,
        S.Espacio_Disco_GB,
        S.Ambiente_Ejecucion,
        S.Tipo_servicio,
        S.Monitoreo_PRTG,
        S.Disponibilidad,
        S.Registro_PRTG,
        S.Observacion,
        S.Criticidad_Organizacion_1,
        S.Criticidad_Organizacion_2,
        S.Dia_Ejecucion_Serv,
        S.Hora_Serv,
        S.tiempo_Respaldo_Serv,
        S.ruta_respaldo_Granular_Serv,
        S.Periodo_Retencion_Serv,
        S.Doble_Copia_Serv,
        S.Dia_Ejecucion_Almac,
        S.Hora_Almac,
        S.ruta_respaldo_Granular_Almac,
        S.Periodo_Retencion_Almac,
        S.Doble_Copia_Almac,
        S.interfaz_red,
        S.velocidad,
        S.hipervisor,
        S.tipo_disco,
        S.fech_despliegue,
        S.antivirus,
        S.firewall,
        S.reglas_aplicadas,
        S.nucleos,

        -- 🔗 Relaciones externas
        E.estnombre AS Estado,
        B.Nombre_Base,
        B.Nombre_Instancia,
        Z.Zona,
        Z.Provincia,
        Z.Ciudad,
        Z.Canton,
        Z.Locacion,
        Z.Ubicacion,
        Z.VCenter

    FROM dbo.Servidores S
    LEFT JOIN dbo.estado E ON S.estcodigo = E.estcodigo
    LEFT JOIN dbo.BaseDatos B ON S.ID_Base = B.ID_Base
    LEFT JOIN dbo.ZONA_A Z ON S.ID_Zona = Z.ID_Zona

    -- 🎯 Filtros dinámicos
    WHERE (@estcodigo IS NULL OR S.estcodigo = @estcodigo)
      AND (@ID_Zona IS NULL OR S.ID_Zona = @ID_Zona)
      AND (@ID_Base IS NULL OR S.ID_Base = @ID_Base)

    -- 📊 Orden lógico
    ORDER BY S.Criticidad_Organizacion_1 DESC, S.Nombre_Servidor ASC;
END
GO
/****** Object:  StoredProcedure [dbo].[get_total_aplicativos_por_servidor]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[get_total_aplicativos_por_servidor]
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        S.ID_Servidor,
        S.Nombre_Servidor,
        COUNT(A.aplcodigo) AS Total_Aplicativos
    FROM dbo.Servidores S
    LEFT JOIN dbo.Servidor_Aplicaciones A ON S.ID_Servidor = A.ID_Servidor
    GROUP BY S.ID_Servidor, S.Nombre_Servidor
    ORDER BY Total_Aplicativos ASC;
END
GO
/****** Object:  StoredProcedure [dbo].[get_total_por_estado]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE   PROCEDURE [dbo].[get_total_por_estado]
AS
BEGIN
    SET NOCOUNT ON;

    SELECT 
        e.estnombre                       AS estado,
        COUNT(*)                          AS totalAplicativos,
        SUM(CASE WHEN a.aplactivo = 1 THEN 1 ELSE 0 END) AS activos,
        SUM(CASE WHEN a.aplactivo = 0 THEN 1 ELSE 0 END) AS inactivos,
        CAST(
            100.0 * SUM(CASE WHEN a.aplactivo = 1 THEN 1 ELSE 0 END) / COUNT(*)
            AS DECIMAL(5,2)
        )                                AS porcentajeActivo
    FROM aplicativo a
    INNER JOIN estado e ON a.estcodigo = e.estcodigo
    GROUP BY e.estnombre
    ORDER BY totalAplicativos DESC;
END
GO
/****** Object:  StoredProcedure [dbo].[get_total_servidores_por_estado]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[get_total_servidores_por_estado]
AS
BEGIN
    SET NOCOUNT ON;

    SELECT
        E.estnombre AS Estado,
        COUNT(S.ID_Servidor) AS Total_Servidores
    FROM dbo.estado E
    LEFT JOIN dbo.Servidores S ON E.estcodigo = S.estcodigo
    GROUP BY E.estnombre
    ORDER BY Total_Servidores ASC;
END
GO
/****** Object:  StoredProcedure [dbo].[getActivoById]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- Obtener activo por ID
CREATE PROCEDURE [dbo].[getActivoById]
    @id_activo_fisico INT
AS
BEGIN
    SELECT * FROM dbo.Activo_Fisico
    WHERE id_activo_fisico = @id_activo_fisico;
END;
GO
/****** Object:  StoredProcedure [dbo].[getAllActivos]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[getAllActivos]
AS
BEGIN
    SELECT 
        af.id_activo_fisico,
        af.Naturaleza,
        af.Activo,
        af.Descripcion_Activo,
        af.Etiqueta_Activo_Fijo,
        af.Codigo_activo_Fijo_EBS,
        af.Fabricante,
        af.Modelo,
        af.Serie,
        af.Num_Contrato,
        af.Fecha_Recepcion,
        af.Caducidad_Garantia,
        af.ID_Zona,
        z.Zona AS Nombre_Zona,
        af.Precio_Compra,
        af.Ubicacion_Desc,
        af.Estado,
        e.empcodigo,
        e.empnombres,
        e.empapellidopaterno,
        e.empapellidomaterno,
        ea.Fecha_Asignacion,
        ea.Fecha_Desasignacion
    FROM dbo.Activo_Fisico af
    LEFT JOIN dbo.ZONA_A z ON af.ID_Zona = z.ID_Zona
    LEFT JOIN dbo.Empleado_Activo ea ON af.id_activo_fisico = ea.ID_Activo_Fisico
    LEFT JOIN dbo.empleado e ON ea.EmpCodigo = e.empcodigo
    ORDER BY af.id_activo_fisico DESC;
END;
GO
/****** Object:  StoredProcedure [dbo].[GetAllEmployee]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO


CREATE PROCEDURE [dbo].[GetAllEmployee]
AS
BEGIN
    SELECT * FROM empleado
END
GO
/****** Object:  StoredProcedure [dbo].[GetAllIPs]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[GetAllIPs]
AS
BEGIN
    SELECT * FROM IP
END
GO
/****** Object:  StoredProcedure [dbo].[insert_aplicativo]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[insert_aplicativo]
    @cricodigo INT,
    @tipccodigo INT,
    @maccodigo INT,
    @hercodigo INT,
    @tipaccesocodigo INT,
    @tipcodigo INT,
    @tfdcodigo INT,
    @estcodigo INT,
    @intcodigo INT,
    @fuecodigo INT,
    @descodigo INT,
    @concodigo INT,
    @aplnombrecorto VARCHAR(50),
    @aplnombrecompleto VARCHAR(250),
    @aplregistro VARCHAR(50),
    @aplfechaadquisicion DATETIME,
    @aplfechaimplementacion DATETIME,
    @aplproveedor VARCHAR(100),
    @aplversion VARCHAR(100),
    @aplanocreacion INT,
    @aplnumerousuario INT,
    @apladministradorusuario VARCHAR(200),
    @aplvalorestimado VARCHAR(100),
    @apltransaccionesmensuales VARCHAR(50),
    @aplfechaactualizacion DATETIME,
    @aplsla VARCHAR(100),
    @aplrutadoctecnico VARCHAR(1000),
    @aplenlace VARCHAR(1200),
    @apltiemporeinicio VARCHAR(200),
    @aplhorareinicio VARCHAR(200),
    @aplactivo INT,
    @apldescripcion VARCHAR(750),
    @aplobservaciones VARCHAR(800),
    @aplhsoportevigente VARCHAR(20),
    @aplhttps INT,
    @aplarearequirente VARCHAR(300),
    @aplsubarea VARCHAR(300),
    @aplproceso VARCHAR(200)
AS
BEGIN
    SET NOCOUNT ON;

    -- 🔍 Validación de claves foráneas
    IF NOT EXISTS (SELECT 1 FROM criticidad WHERE cricodigo = @cricodigo)
        THROW 50001, 'Código de criticidad inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM tipo_catastro WHERE tipccodigo = @tipccodigo)
        THROW 50002, 'Código de tipo catastro inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM herramienta WHERE hercodigo = @hercodigo)
        THROW 50003, 'Código de herramienta inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM tipo_acceso WHERE tipaccesocodigo = @tipaccesocodigo)
        THROW 50004, 'Código de tipo acceso inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM tipo_usuario WHERE tipcodigo = @tipcodigo)
        THROW 50005, 'Código de tipo usuario inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM tipo_fuentedatos WHERE tfdcodigo = @tfdcodigo)
        THROW 50006, 'Código de fuente de datos inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM estado WHERE estcodigo = @estcodigo)
        THROW 50007, 'Código de estado inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM tipo_integracion WHERE intcodigo = @intcodigo)
        THROW 50008, 'Código de integración inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM fuente WHERE fuecodigo = @fuecodigo)
        THROW 50009, 'Código de fuente inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM desarrollo WHERE descodigo = @descodigo)
        THROW 50010, 'Código de desarrollo inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM control WHERE concodigo = @concodigo)
        THROW 50011, 'Código de control inválido.', 1;

    -- 🧾 Inserción principal
    INSERT INTO aplicativo (
        cricodigo, tipccodigo, maccodigo, hercodigo, tipaccesocodigo,
        tipcodigo, tfdcodigo, estcodigo, intcodigo, fuecodigo,
        descodigo, concodigo, aplnombrecorto, aplnombrecompleto,
        aplregistro, aplfechaadquisicion, aplfechaimplementacion,
        aplproveedor, aplversion, aplanocreacion, aplnumerousuario,
        apladministradorusuario, aplvalorestimado, apltransaccionesmensuales,
        aplfechaactualizacion, aplsla, aplrutadoctecnico, aplenlace,
        apltiemporeinicio, aplhorareinicio, aplactivo, apldescripcion,
        aplobservaciones, aplhsoportevigente, aplhttps, aplarearequirente,
        aplsubarea, aplproceso
    )
    VALUES (
        @cricodigo, @tipccodigo, @maccodigo, @hercodigo, @tipaccesocodigo,
        @tipcodigo, @tfdcodigo, @estcodigo, @intcodigo, @fuecodigo,
        @descodigo, @concodigo, @aplnombrecorto, @aplnombrecompleto,
        @aplregistro, @aplfechaadquisicion, @aplfechaimplementacion,
        @aplproveedor, @aplversion, @aplanocreacion, @aplnumerousuario,
        @apladministradorusuario, @aplvalorestimado, @apltransaccionesmensuales,
        @aplfechaactualizacion, @aplsla, @aplrutadoctecnico, @aplenlace,
        @apltiemporeinicio, @aplhorareinicio, @aplactivo, @apldescripcion,
        @aplobservaciones, @aplhsoportevigente, @aplhttps, @aplarearequirente,
        @aplsubarea, @aplproceso
    );
END
GO
/****** Object:  StoredProcedure [dbo].[insert_employee]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[insert_employee]
    @empnombres VARCHAR(100),
    @empapellidopaterno VARCHAR(100),
    @empapellidomaterno VARCHAR(100),
    @empcedula VARCHAR(40),
    @empemail VARCHAR(100),
    @empcelular VARCHAR(20),
    @emptiposangre VARCHAR(5),
    @empsexo CHAR(1),
    @empfechainicio DATE,
    @empusuario VARCHAR(100),
    @empactivo INT,
    @empdescripcion VARCHAR(500),
    @empobservaciones VARCHAR(500),
    @arecodigo INT,
    @rolcodigo INT,
    @percodigo INT
AS
BEGIN
    INSERT INTO empleado (
        empnombres, empapellidopaterno, empapellidomaterno, empcedula,
        empemail, empcelular, emptiposangre, empsexo,
        empfechainicio, empfechacreacion,
        empusuario, empactivo, empdescripcion, empobservaciones
    )
    VALUES (
        @empnombres, @empapellidopaterno, @empapellidomaterno, @empcedula,
        @empemail, @empcelular, @emptiposangre, @empsexo,
        @empfechainicio, GETDATE(),
        @empusuario, @empactivo, @empdescripcion, @empobservaciones
    );

    DECLARE @newId INT = SCOPE_IDENTITY();

    INSERT INTO areaempleado (empcodigo, arecodigo) VALUES (@newId, @arecodigo);
    INSERT INTO rolempleado (empcodigo, rolcodigo) VALUES (@newId, @rolcodigo);
    INSERT INTO perfilempleado (empcodigo, percodigo) VALUES (@newId, @percodigo);
END
GO
/****** Object:  StoredProcedure [dbo].[insert_servidor]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[insert_servidor]
    @Nombre_Servidor VARCHAR(100),
    @Monitoreo_PRTG VARCHAR(250),
    @Disponibilidad VARCHAR(250),
    @Observacion VARCHAR(200),
    @Registro_PRTG VARCHAR(100),
    @Tipo_Equipo VARCHAR(100),
    @OS VARCHAR(200),
    @Espacio_Disco_GB VARCHAR(100),
    @Criticidad_Organizacion_1 INT,
    @Criticidad_Organizacion_2 INT,
    @Tipo_servicio VARCHAR(100),
    @Ambiente_Ejecucion VARCHAR(100),
    @Dia_Ejecucion_Serv VARCHAR(250),
    @Hora_Serv VARCHAR(250),
    @tiempo_Respaldo_Serv VARCHAR(100),
    @ruta_respaldo_Granular_Serv VARCHAR(200),
    @Periodo_Retencion_Serv VARCHAR(100),
    @Doble_Copia_Serv VARCHAR(250),
    @Dia_Ejecucion_Almac VARCHAR(250),
    @Hora_Almac VARCHAR(250),
    @ruta_respaldo_Granular_Almac VARCHAR(200),
    @Periodo_Retencion_Almac VARCHAR(100),
    @Doble_Copia_Almac VARCHAR(100),
    @interfaz_red VARCHAR(255),
    @velocidad VARCHAR(50),
    @hipervisor VARCHAR(100),
    @numero_discos INT,
    @uso_disco VARCHAR(255),
    @memoria_ram VARCHAR(255),
    @procesador VARCHAR(255),
    @tipo_disco VARCHAR(10),
    @fech_despliegue VARCHAR(MAX),
    @antivirus VARCHAR(5),
    @firewall VARCHAR(255),
    @reglas_aplicadas VARCHAR(255),
    @nucleos INT,
    @ID_Zona INT,
    @estcodigo INT,
    @ID_Base INT
AS
BEGIN
    SET NOCOUNT ON;

    -- 🔍 Validación de claves foráneas
    IF NOT EXISTS (SELECT 1 FROM estado WHERE estcodigo = @estcodigo)
        THROW 54001, 'Código de estado inválido.', 1;

    IF NOT EXISTS (SELECT 1 FROM ZONA_A WHERE ID_Zona = @ID_Zona)
        THROW 54002, 'Código de zona inválido.', 1;

    IF NOT EXISTS (SELECT 1 FROM BaseDatos WHERE ID_Base = @ID_Base)
        THROW 54003, 'Código de base de datos inválido.', 1;

    -- 🧾 Inserción principal
    INSERT INTO dbo.Servidores (
        Nombre_Servidor, Monitoreo_PRTG, Disponibilidad, Observacion, Registro_PRTG,
        Tipo_Equipo, OS, Espacio_Disco_GB, Criticidad_Organizacion_1, Criticidad_Organizacion_2,
        Tipo_servicio, Ambiente_Ejecucion, Dia_Ejecucion_Serv, Hora_Serv, tiempo_Respaldo_Serv,
        ruta_respaldo_Granular_Serv, Periodo_Retencion_Serv, Doble_Copia_Serv,
        Dia_Ejecucion_Almac, Hora_Almac, ruta_respaldo_Granular_Almac, Periodo_Retencion_Almac,
        Doble_Copia_Almac, interfaz_red, velocidad, hipervisor, numero_discos, uso_disco,
        memoria_ram, procesador, tipo_disco, fech_despliegue, antivirus, firewall,
        reglas_aplicadas, nucleos, ID_Zona, estcodigo, ID_Base
    )
    VALUES (
        @Nombre_Servidor, @Monitoreo_PRTG, @Disponibilidad, @Observacion, @Registro_PRTG,
        @Tipo_Equipo, @OS, @Espacio_Disco_GB, @Criticidad_Organizacion_1, @Criticidad_Organizacion_2,
        @Tipo_servicio, @Ambiente_Ejecucion, @Dia_Ejecucion_Serv, @Hora_Serv, @tiempo_Respaldo_Serv,
        @ruta_respaldo_Granular_Serv, @Periodo_Retencion_Serv, @Doble_Copia_Serv,
        @Dia_Ejecucion_Almac, @Hora_Almac, @ruta_respaldo_Granular_Almac, @Periodo_Retencion_Almac,
        @Doble_Copia_Almac, @interfaz_red, @velocidad, @hipervisor, @numero_discos, @uso_disco,
        @memoria_ram, @procesador, @tipo_disco, @fech_despliegue, @antivirus, @firewall,
        @reglas_aplicadas, @nucleos, @ID_Zona, @estcodigo, @ID_Base
    );
END
GO
/****** Object:  StoredProcedure [dbo].[insertActivo]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[insertActivo]
    @Naturaleza NVARCHAR(50),
    @Activo NVARCHAR(50),
    @Gestion_TIC NVARCHAR(50),
    @Descripcion_Activo NVARCHAR(MAX),
    @Etiqueta_Activo_Fijo NVARCHAR(150),
    @Codigo_activo_Fijo_EBS NVARCHAR(50),
    @Centro_Costo NVARCHAR(50),
    @Fabricante NVARCHAR(100),
    @Modelo NVARCHAR(150),
    @Serie NVARCHAR(100),
    @Num_Contrato NVARCHAR(150),
    @Fecha_Recepcion DATETIME,
    @Caducidad_Garantia DATETIME,
    @ID_Zona INT,
    @Precio_Compra DECIMAL(18,2),
    @Ubicacion_Desc NVARCHAR(MAX),
    @Estado NVARCHAR(50)
AS
BEGIN
    INSERT INTO dbo.Activo_Fisico (
        Naturaleza, Activo, Gestion_TIC, Descripcion_Activo, Etiqueta_Activo_Fijo,
        Codigo_activo_Fijo_EBS, Centro_Costo, Fabricante, Modelo, Serie, Num_Contrato,
        Fecha_Recepcion, Caducidad_Garantia, ID_Zona, Precio_Compra, Ubicacion_Desc, Estado
    )
    VALUES (
        @Naturaleza, @Activo, @Gestion_TIC, @Descripcion_Activo, @Etiqueta_Activo_Fijo,
        @Codigo_activo_Fijo_EBS, @Centro_Costo, @Fabricante, @Modelo, @Serie, @Num_Contrato,
        @Fecha_Recepcion, @Caducidad_Garantia, @ID_Zona, @Precio_Compra, @Ubicacion_Desc, @Estado
    );
END;
GO
/****** Object:  StoredProcedure [dbo].[insertEmpleadoActivo]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

-- Creado por Marlyn Almeida - 07/08/2025
CREATE PROCEDURE [dbo].[insertEmpleadoActivo]
  @ID_Activo_Fisico INT,
  @EmpCodigo INT
AS
BEGIN
  INSERT INTO Empleado_Activo (
    ID_Activo_Fisico,
    EmpCodigo,
    Fecha_Asignacion
  )
  VALUES (
    @ID_Activo_Fisico,
    @EmpCodigo,
    GETDATE()
  );
END;
GO
/****** Object:  StoredProcedure [dbo].[InsertIP]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[InsertIP]
    @Direccion_IP VARCHAR(250),
    @Estado_Ip BIT,
    @Gateway VARCHAR(250),
    @Mascara_Subred VARCHAR(100),
    @Rango VARCHAR(250),
    @DNS1 VARCHAR(250),
    @DNS2 VARCHAR(250)
AS
BEGIN
    INSERT INTO IP (Direccion_IP, Estado_Ip, Gateway, Mascara_Subred, Rango, DNS1, DNS2)
    VALUES (@Direccion_IP, @Estado_Ip, @Gateway, @Mascara_Subred, @Rango, @DNS1, @DNS2)
END
GO
/****** Object:  StoredProcedure [dbo].[is_activo_libre]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[is_activo_libre]
    @ID_Activo_Fisico INT
AS
BEGIN
    SELECT COUNT(*) AS AsignacionesActivas
    FROM Empleado_Activo
    WHERE ID_Activo_Fisico = @ID_Activo_Fisico AND Fecha_Desasignacion IS NULL;
END;
GO
/****** Object:  StoredProcedure [dbo].[remove_asignacion]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[remove_asignacion]
    @ID_Activo_Fisico INT
AS
BEGIN
    UPDATE Empleado_Activo
    SET Fecha_Desasignacion = GETDATE()
    WHERE ID_Activo_Fisico = @ID_Activo_Fisico AND Fecha_Desasignacion IS NULL;
END;
GO
/****** Object:  StoredProcedure [dbo].[update_aplicativo]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[update_aplicativo]
    @aplcodigo INT,
    @cricodigo INT,
    @tipccodigo INT,
    @maccodigo INT,
    @hercodigo INT,
    @tipaccesocodigo INT,
    @tipcodigo INT,
    @tfdcodigo INT,
    @estcodigo INT,
    @intcodigo INT,
    @fuecodigo INT,
    @descodigo INT,
    @concodigo INT,
    @aplnombrecorto VARCHAR(50),
    @aplnombrecompleto VARCHAR(250),
    @aplregistro VARCHAR(50),
    @aplfechaadquisicion DATETIME,
    @aplfechaimplementacion DATETIME,
    @aplproveedor VARCHAR(100),
    @aplversion VARCHAR(100),
    @aplanocreacion INT,
    @aplnumerousuario INT,
    @apladministradorusuario VARCHAR(200),
    @aplvalorestimado VARCHAR(100),
    @apltransaccionesmensuales VARCHAR(50),
    @aplfechaactualizacion DATETIME,
    @aplsla VARCHAR(100),
    @aplrutadoctecnico VARCHAR(1000),
    @aplenlace VARCHAR(1200),
    @apltiemporeinicio VARCHAR(200),
    @aplhorareinicio VARCHAR(200),
    @aplactivo INT,
    @apldescripcion VARCHAR(750),
    @aplobservaciones VARCHAR(800),
    @aplhsoportevigente VARCHAR(20),
    @aplhttps INT,
    @aplarearequirente VARCHAR(300),
    @aplsubarea VARCHAR(300),
    @aplproceso VARCHAR(200)
AS
BEGIN
    SET NOCOUNT ON;

    -- 🔍 Validación de existencia
    IF NOT EXISTS (SELECT 1 FROM aplicativo WHERE aplcodigo = @aplcodigo)
        THROW 50100, 'El aplicativo especificado no existe.', 1;

    -- 🔐 Validación de claves foráneas
    IF NOT EXISTS (SELECT 1 FROM criticidad WHERE cricodigo = @cricodigo)
        THROW 50101, 'Código de criticidad inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM tipo_catastro WHERE tipccodigo = @tipccodigo)
        THROW 50102, 'Código de tipo catastro inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM herramienta WHERE hercodigo = @hercodigo)
        THROW 50103, 'Código de herramienta inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM tipo_acceso WHERE tipaccesocodigo = @tipaccesocodigo)
        THROW 50104, 'Código de tipo acceso inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM tipo_usuario WHERE tipcodigo = @tipcodigo)
        THROW 50105, 'Código de tipo usuario inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM tipo_fuentedatos WHERE tfdcodigo = @tfdcodigo)
        THROW 50106, 'Código de fuente de datos inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM estado WHERE estcodigo = @estcodigo)
        THROW 50107, 'Código de estado inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM tipo_integracion WHERE intcodigo = @intcodigo)
        THROW 50108, 'Código de integración inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM fuente WHERE fuecodigo = @fuecodigo)
        THROW 50109, 'Código de fuente inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM desarrollo WHERE descodigo = @descodigo)
        THROW 50110, 'Código de desarrollo inválido.', 1;
    IF NOT EXISTS (SELECT 1 FROM control WHERE concodigo = @concodigo)
        THROW 50111, 'Código de control inválido.', 1;

    -- 🔄 Actualización completa
    UPDATE aplicativo
    SET
        cricodigo = @cricodigo,
        tipccodigo = @tipccodigo,
        maccodigo = @maccodigo,
        hercodigo = @hercodigo,
        tipaccesocodigo = @tipaccesocodigo,
        tipcodigo = @tipcodigo,
        tfdcodigo = @tfdcodigo,
        estcodigo = @estcodigo,
        intcodigo = @intcodigo,
        fuecodigo = @fuecodigo,
        descodigo = @descodigo,
        concodigo = @concodigo,
        aplnombrecorto = @aplnombrecorto,
        aplnombrecompleto = @aplnombrecompleto,
        aplregistro = @aplregistro,
        aplfechaadquisicion = @aplfechaadquisicion,
        aplfechaimplementacion = @aplfechaimplementacion,
        aplproveedor = @aplproveedor,
        aplversion = @aplversion,
        aplanocreacion = @aplanocreacion,
        aplnumerousuario = @aplnumerousuario,
        apladministradorusuario = @apladministradorusuario,
        aplvalorestimado = @aplvalorestimado,
        apltransaccionesmensuales = @apltransaccionesmensuales,
        aplfechaactualizacion = @aplfechaactualizacion,
        aplsla = @aplsla,
        aplrutadoctecnico = @aplrutadoctecnico,
        aplenlace = @aplenlace,
        apltiemporeinicio = @apltiemporeinicio,
        aplhorareinicio = @aplhorareinicio,
        aplactivo = @aplactivo,
        apldescripcion = @apldescripcion,
        aplobservaciones = @aplobservaciones,
        aplhsoportevigente = @aplhsoportevigente,
        aplhttps = @aplhttps,
        aplarearequirente = @aplarearequirente,
        aplsubarea = @aplsubarea,
        aplproceso = @aplproceso
    WHERE aplcodigo = @aplcodigo;
END
GO
/****** Object:  StoredProcedure [dbo].[update_employee]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE   PROCEDURE [dbo].[update_employee]
    @empcodigo INT,
    @empnombres VARCHAR(100),
    @empapellidopaterno VARCHAR(100),
    @empapellidomaterno VARCHAR(100),
    @empcedula VARCHAR(40),
    @empemail VARCHAR(100),
    @empcelular VARCHAR(20),
    @emptiposangre VARCHAR(5),
    @empsexo CHAR(1),
    @empfechainicio DATE,
    @empusuario VARCHAR(100),
    @empactivo INT,
    @empdescripcion VARCHAR(500),
    @empobservaciones VARCHAR(500),
    @arecodigo INT,
    @rolcodigo INT,
    @percodigo INT
AS
BEGIN
    UPDATE empleado
    SET
        empnombres = @empnombres,
        empapellidopaterno = @empapellidopaterno,
        empapellidomaterno = @empapellidomaterno,
        empcedula = @empcedula,
        empemail = @empemail,
        empcelular = @empcelular,
        emptiposangre = @emptiposangre,
        empsexo = @empsexo,
        empfechainicio = @empfechainicio,
        empusuario = @empusuario,
        empactivo = @empactivo,
        empdescripcion = @empdescripcion,
        empobservaciones = @empobservaciones
    WHERE empcodigo = @empcodigo;

    DELETE FROM areaempleado WHERE empcodigo = @empcodigo;
    INSERT INTO areaempleado (empcodigo, arecodigo) VALUES (@empcodigo, @arecodigo);

    DELETE FROM rolempleado WHERE empcodigo = @empcodigo;
    INSERT INTO rolempleado (empcodigo, rolcodigo) VALUES (@empcodigo, @rolcodigo);

    DELETE FROM perfilempleado WHERE empcodigo = @empcodigo;
    INSERT INTO perfilempleado (empcodigo, percodigo) VALUES (@empcodigo, @percodigo);
END
GO
/****** Object:  StoredProcedure [dbo].[update_servidor]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE PROCEDURE [dbo].[update_servidor]
    @ID_Servidor INT,
    @Nombre_Servidor VARCHAR(100),
    @Monitoreo_PRTG VARCHAR(250),
    @Disponibilidad VARCHAR(250),
    @Observacion VARCHAR(200),
    @Registro_PRTG VARCHAR(100),
    @Tipo_Equipo VARCHAR(100),
    @OS VARCHAR(200),
    @Espacio_Disco_GB VARCHAR(100),
    @Criticidad_Organizacion_1 INT,
    @Criticidad_Organizacion_2 INT,
    @Tipo_servicio VARCHAR(100),
    @Ambiente_Ejecucion VARCHAR(100),
    @Dia_Ejecucion_Serv VARCHAR(250),
    @Hora_Serv VARCHAR(250),
    @tiempo_Respaldo_Serv VARCHAR(100),
    @ruta_respaldo_Granular_Serv VARCHAR(200),
    @Periodo_Retencion_Serv VARCHAR(100),
    @Doble_Copia_Serv VARCHAR(250),
    @Dia_Ejecucion_Almac VARCHAR(250),
    @Hora_Almac VARCHAR(250),
    @ruta_respaldo_Granular_Almac VARCHAR(200),
    @Periodo_Retencion_Almac VARCHAR(100),
    @Doble_Copia_Almac VARCHAR(100),
    @interfaz_red VARCHAR(255),
    @velocidad VARCHAR(50),
    @hipervisor VARCHAR(100),
    @numero_discos INT,
    @uso_disco VARCHAR(255),
    @memoria_ram VARCHAR(255),
    @procesador VARCHAR(255),
    @tipo_disco VARCHAR(10),
    @fech_despliegue VARCHAR(MAX),
    @antivirus VARCHAR(5),
    @firewall VARCHAR(255),
    @reglas_aplicadas VARCHAR(255),
    @nucleos INT,
    @ID_Zona INT,
    @estcodigo INT,
    @ID_Base INT
AS
BEGIN
    SET NOCOUNT ON;

    -- 🔍 Validación de existencia del servidor
    IF NOT EXISTS (SELECT 1 FROM Servidores WHERE ID_Servidor = @ID_Servidor)
        THROW 54010, 'Servidor no encontrado.', 1;

    -- 🔍 Validación de claves foráneas
    IF NOT EXISTS (SELECT 1 FROM estado WHERE estcodigo = @estcodigo)
        THROW 54011, 'Código de estado inválido.', 1;

    IF NOT EXISTS (SELECT 1 FROM ZONA_A WHERE ID_Zona = @ID_Zona)
        THROW 54012, 'Código de zona inválido.', 1;

    IF NOT EXISTS (SELECT 1 FROM BaseDatos WHERE ID_Base = @ID_Base)
        THROW 54013, 'Código de base de datos inválido.', 1;

    -- 🔧 Actualización semántica
    UPDATE dbo.Servidores
    SET
        Nombre_Servidor = @Nombre_Servidor,
        Monitoreo_PRTG = @Monitoreo_PRTG,
        Disponibilidad = @Disponibilidad,
        Observacion = @Observacion,
        Registro_PRTG = @Registro_PRTG,
        Tipo_Equipo = @Tipo_Equipo,
        OS = @OS,
        Espacio_Disco_GB = @Espacio_Disco_GB,
        Criticidad_Organizacion_1 = @Criticidad_Organizacion_1,
        Criticidad_Organizacion_2 = @Criticidad_Organizacion_2,
        Tipo_servicio = @Tipo_servicio,
        Ambiente_Ejecucion = @Ambiente_Ejecucion,
        Dia_Ejecucion_Serv = @Dia_Ejecucion_Serv,
        Hora_Serv = @Hora_Serv,
        tiempo_Respaldo_Serv = @tiempo_Respaldo_Serv,
        ruta_respaldo_Granular_Serv = @ruta_respaldo_Granular_Serv,
        Periodo_Retencion_Serv = @Periodo_Retencion_Serv,
        Doble_Copia_Serv = @Doble_Copia_Serv,
        Dia_Ejecucion_Almac = @Dia_Ejecucion_Almac,
        Hora_Almac = @Hora_Almac,
        ruta_respaldo_Granular_Almac = @ruta_respaldo_Granular_Almac,
        Periodo_Retencion_Almac = @Periodo_Retencion_Almac,
        Doble_Copia_Almac = @Doble_Copia_Almac,
        interfaz_red = @interfaz_red,
        velocidad = @velocidad,
        hipervisor = @hipervisor,
        numero_discos = @numero_discos,
        uso_disco = @uso_disco,
        memoria_ram = @memoria_ram,
        procesador = @procesador,
        tipo_disco = @tipo_disco,
        fech_despliegue = @fech_despliegue,
        antivirus = @antivirus,
        firewall = @firewall,
        reglas_aplicadas = @reglas_aplicadas,
        nucleos = @nucleos,
        ID_Zona = @ID_Zona,
        estcodigo = @estcodigo,
        ID_Base = @ID_Base
    WHERE ID_Servidor = @ID_Servidor;
END
GO
/****** Object:  StoredProcedure [dbo].[updateActivo]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO



CREATE PROCEDURE [dbo].[updateActivo]
    @id_activo_fisico INT,
    @Naturaleza NVARCHAR(50),
    @Activo NVARCHAR(50),
    @Gestion_TIC NVARCHAR(50),
    @Descripcion_Activo NVARCHAR(MAX),
    @Etiqueta_Activo_Fijo NVARCHAR(150),
    @Codigo_activo_Fijo_EBS NVARCHAR(50),
    @Centro_Costo NVARCHAR(50),
    @Fabricante NVARCHAR(100),
    @Modelo NVARCHAR(150),
    @Serie NVARCHAR(100),
    @Num_Contrato NVARCHAR(150),
    @Fecha_Recepcion DATETIME,
    @Caducidad_Garantia DATETIME,
    @ID_Zona INT,
    @Precio_Compra DECIMAL(18,2),
    @Ubicacion_Desc NVARCHAR(MAX),
    @Estado NVARCHAR(50)
AS
BEGIN
    UPDATE dbo.Activo_Fisico
    SET Naturaleza = @Naturaleza,
        Activo = @Activo,
        Gestion_TIC = @Gestion_TIC,
        Descripcion_Activo = @Descripcion_Activo,
        Etiqueta_Activo_Fijo = @Etiqueta_Activo_Fijo,
        Codigo_activo_Fijo_EBS = @Codigo_activo_Fijo_EBS,
        Centro_Costo = @Centro_Costo,
        Fabricante = @Fabricante,
        Modelo = @Modelo,
        Serie = @Serie,
        Num_Contrato = @Num_Contrato,
        Fecha_Recepcion = @Fecha_Recepcion,
        Caducidad_Garantia = @Caducidad_Garantia,
        ID_Zona = @ID_Zona,
        Precio_Compra = @Precio_Compra,
        Ubicacion_Desc = @Ubicacion_Desc,
        Estado = @Estado
    WHERE id_activo_fisico = @id_activo_fisico;
END;
GO
/****** Object:  StoredProcedure [dbo].[UpdateIP]    Script Date: 22/8/2025 14:16:01 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[UpdateIP]
    @ID_IP INT,
    @Direccion_IP VARCHAR(250),
    @Estado_Ip BIT,
    @Gateway VARCHAR(250),
    @Mascara_Subred VARCHAR(100),
    @Rango VARCHAR(250),
    @DNS1 VARCHAR(250),
    @DNS2 VARCHAR(250)
AS
BEGIN
    UPDATE IP
    SET Direccion_IP = @Direccion_IP,
        Estado_Ip = @Estado_Ip,
        Gateway = @Gateway,
        Mascara_Subred = @Mascara_Subred,
        Rango = @Rango,
        DNS1 = @DNS1,
        DNS2 = @DNS2
    WHERE ID_IP = @ID_IP
END
GO
