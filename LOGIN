USE [MSQCATPRO_MA]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE PROCEDURE [dbo].[sp_login_empleado]
    @empusuario VARCHAR(100),
    @empcontrasena VARCHAR(100)
AS
BEGIN
    SET NOCOUNT ON;

    -- üîë Buscar usuario activo
    DECLARE @hashed_password VARCHAR(64);
    SET @hashed_password = CONVERT(VARCHAR(64), HASHBYTES('SHA2_256', @empcontrasena), 2);

    DECLARE @usuario_count INT;
    DECLARE @credenciales_count INT;

    -- Verificar si el usuario existe y est√° activo
    SELECT @usuario_count = COUNT(*)
    FROM empleado
    WHERE empusuario = @empusuario AND empactivo = 1;

    IF @usuario_count = 0
    BEGIN
        -- Usuario no existe o est√° inactivo
        SELECT 'error' AS status, 'El usuario no existe o est√° inactivo.' AS message;
        RETURN;
    END

    -- Verificar credenciales
    SELECT @credenciales_count = COUNT(*)
    FROM empleado
    WHERE empusuario = @empusuario AND empcontrasena = @hashed_password AND empactivo = 1;

    IF @credenciales_count = 0
    BEGIN
        -- Contrase√±a incorrecta
        SELECT 'error' AS status, 'Credenciales incorrectas.' AS message;
        RETURN;
    END

    -- ‚úÖ Login exitoso: retornar datos m√≠nimos
    SELECT empcodigo, empusuario
    FROM empleado
    WHERE empusuario = @empusuario AND empactivo = 1;
END
GO
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
USE [MSQCATPRO_MA]
GO
/****** Object:  Table [dbo].[empleado]    Script Date: 1/9/2025 22:45:17 ******/
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO
CREATE TABLE [dbo].[empleado](
	[empcodigo] [int] IDENTITY(1,1) NOT NULL,
	[empnombres] [varchar](100) NOT NULL,
	[empapellidopaterno] [varchar](100) NOT NULL,
	[empapellidomaterno] [varchar](100) NULL,
	[empcedula] [varchar](40) NULL,
	[empemail] [varchar](100) NULL,
	[empcelular] [varchar](20) NULL,
	[emptiposangre] [varchar](5) NULL,
	[empsexo] [char](1) NULL,
	[empfechainicio] [datetime] NULL,
	[empfechacreacion] [datetime] NULL,
	[empusuario] [varchar](100) NULL,
	[empcontrasena] [varchar](100) NULL,
	[empactivo] [int] NULL,
	[empdescripcion] [varchar](500) NULL,
	[empobservaciones] [varchar](500) NULL,
 CONSTRAINT [pk_empleado] PRIMARY KEY NONCLUSTERED 
(
	[empcodigo] ASC
)WITH (PAD_INDEX = OFF, STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF, ALLOW_ROW_LOCKS = ON, ALLOW_PAGE_LOCKS = ON, OPTIMIZE_FOR_SEQUENTIAL_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY]
GO



INSERT INTO empleado (
    empnombres,
    empapellidopaterno,
    empusuario,
    empcontrasena,
    empactivo,
    empfechacreacion
)
VALUES (
    'Super',
    'Admin',
    'admin',
    CONVERT(VARCHAR(64), HASHBYTES('SHA2_256', '12345'), 2), -- üîê Contrase√±a en hash
    1,
    GETDATE()
);



USE [MSQCATPRO_MA];
GO


INSERT INTO dbo.empleado (
    empnombres,
    empapellidopaterno,
    empusuario,
    empcontrasena,
    empactivo,
    empfechacreacion
)
VALUES (
    'Super',
    'Admin',
    'admin',
    CONVERT(VARCHAR(64), HASHBYTES('SHA2_256', '12345'), 2),
    1,
    GETDATE()
);




















USE [MSQCATPRO_MA]
GO
SET ANSI_NULLS ON
GO
SET QUOTED_IDENTIFIER ON
GO

CREATE OR ALTER PROCEDURE [dbo].[sp_login_empleado]
    @empusuario VARCHAR(100),
    @empcontrasena VARCHAR(100)
AS
BEGIN
    SET NOCOUNT ON;

    -- üîë Buscar usuario activo
    DECLARE @hashed_password VARCHAR(64);
    SET @hashed_password = CONVERT(VARCHAR(64), HASHBYTES('SHA2_256', @empcontrasena), 2);

    DECLARE @usuario_count INT;
    DECLARE @credenciales_count INT;

    -- Verificar si el usuario existe y est√° activo
    SELECT @usuario_count = COUNT(*)
    FROM empleado
    WHERE empusuario = @empusuario AND empactivo = 1;

    IF @usuario_count = 0
    BEGIN
        -- Usuario no existe o est√° inactivo
        SELECT 'error' AS status, 'El usuario no existe o est√° inactivo.' AS message;
        RETURN;
    END

    -- Verificar credenciales
    SELECT @credenciales_count = COUNT(*)
    FROM empleado
    WHERE empusuario = @empusuario AND empcontrasena = @hashed_password AND empactivo = 1;

    IF @credenciales_count = 0
    BEGIN
        -- Contrase√±a incorrecta
        SELECT 'error' AS status, 'Credenciales incorrectas.' AS message;
        RETURN;
    END

    -- ‚úÖ Login exitoso: retornar datos m√≠nimos
    SELECT empcodigo, empusuario
    FROM empleado
    WHERE empusuario = @empusuario AND empactivo = 1;
END
GO

